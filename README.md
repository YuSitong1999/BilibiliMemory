# Bilibili Memory 哔哩哔哩记忆

## 介绍

保存 [哔哩哔哩](https://www.bilibili.com/) 收藏的视频

Save your favorite videos at [bilibili](https://www.bilibili.com/) to disk.

使用 [FFmpeg](http://ffmpeg.org/) 合并m4s音频和视频

## 运行

```
编辑config.ini

python main.py update

python main.py clean

python main.py check

```

## 文件保存结构

* config.ini 配置文件：位于执行程序的当前目录


* {output} \ 输出目录
    * all \ 保存所有下载合并后的投稿文件
        * [bv_id]\_ \([pageID]\) .[mp4|json|jpg] 视频、介绍文字、图片
    * deleted \ 已被删除的投稿文件
        * [title]\_ \([pageID]\_[pageTitle]\_\) [bv_id].[mp4|json|jpg] 指向视频、介绍文字、图片（标题均为转换后可用于文件名的标题）
    * [userID] \\ [favFolderID] \\ 仅供浏览：分用户、收藏夹保存硬链接
        * 同上


* {mate} \ 元数据目录（可以和输出目录相同）
    * media.json 所有本地投稿信息：未被删除和已被删除投稿，包括投稿编号和是否分P，最后更新时间。
    * folder.json 本地收藏夹情况：各用户创建的收藏夹，和各收藏夹已下载的投稿ID
    * lost.json 已丢失收藏的残余信息


* {tmp} \ 临时目录（可以和输出目录相同）
    * tmp_\[audio|video] \(_[pageID]\) .m4s 正在下载的视频音频文件
    * tmp_media \(_[pageID]\) .mp4 已合并的较靠前分P

## 程序流程

### clean 多余文件清理

1. {output} \ 中，删除all和deleted中存在，但medias.json中不存在的文件、文件夹。
    1. BV开头文件
    2. 纯数字文件夹
2. {tmp} \ 中，删除以tmp开头的所有文件。

### check 检查元数据完整性

1. 检查media和folder中的内容，在磁盘上是否存在

2. 如果不存在，移除记录或下载文件

### update 更新收藏信息

1. 确保配置存在并读取：检查是否存在config.ini，没有则写入默认配置并退出，有则读取：
    1. 目录配置{output}{meta}{tmp}
    2. 目标用户：用户ID，以逗号分隔
    3. 文件限制配置：
        1. 时间限制：只下载最后更新时间在此之后的投稿
        2. 时长限制：最短直接下载，中等进行询问，最长直接跳过
    4. 安全模式：不删除确定取消收藏的文件
2. 确保目录存在：输出目录、元数据目录、临时目录如果没有则创建。
3. 确保文件存在并读取：media.json、folder.json、lost.json如果没有则创建。
    1. 从media中读取 **本地全部** 包括 **本地已收藏** 和 **本地被删除**
    2. 从folder中读取之前已下载的用户收藏夹收藏
4. 获取线上状态：对于所有用户，获取所有或指定收藏夹包含的投稿信息：
   **线上全部** 包括 **线上可访问** 和 **线上被删除**

5. 对投稿执行操作
    1. 遗失投稿抢救信息，更新lost： **线上被删除** - **本地全部**
    2. 新收藏投稿下载，之后更新media： **线上可访问** - **本地全部**
    3. 新取消收藏非安全模式删除： **本地已收藏** - **线上全部** 且 可访问
    4. 新被删除创建链接，之后更新media： **本地已收藏** 且 **线上被删除**
    5. 新疑似被删除创建链接，之后更新media： **本地已收藏** - **线上全部** 且不可访问
    6. 新复活投稿删除链接，之前更新media： **线上可访问** 且 **本地已删除**

6. 重建浏览文件夹
    1. 确保所有线上存在的用户的收藏夹存在
    2. 只要收藏的内容在本地存在，就创建硬链接

## TODO

### 功能

- [ ] 下载指定用户创建的指定公开收藏夹
- [ ] 增量下载新收藏的视频
- [ ] 支持下载指定日期后的内容
- [ ] 支持询问和跳过指定时长以上的内容
- [ ] 支持利用cookies下载私密收藏的视频
- [ ] 检查元数据完整性
- [ ] 清除多余文件
- [ ] 支持更新已下载但被up主更新的视频
